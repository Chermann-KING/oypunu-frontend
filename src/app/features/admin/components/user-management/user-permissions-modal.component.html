<div class="modal-overlay" *ngIf="visible" (click)="onBackdropClick($event)">
  <div class="permissions-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true">

    <!-- Header de la modale -->
    <div class="modal-header">
      <div class="header-content">
        <h2 id="modal-title" class="modal-title">
          Permissions de {{ user?.username }}
        </h2>
        <p class="modal-subtitle" *ngIf="user">
          Gestion des autorisations pour {{ user.email }}
        </p>
      </div>
      <button class="btn-close" (click)="onAction('cancel')" [attr.aria-label]="'Fermer la modale'" type="button">
        <i class="icon-x"></i>
      </button>
    </div>

    <!-- Indicateur de chargement -->
    <div class="modal-loading" *ngIf="isLoading">
      <div class="loading-spinner"></div>
      <p>Chargement des permissions...</p>
    </div>

    <!-- Message d'erreur -->
    <div class="modal-error" *ngIf="errorMessage" role="alert">
      <i class="icon-alert-circle"></i>
      <span>{{ errorMessage }}</span>
      <button class="btn btn-sm" (click)="onRefresh()">Réessayer</button>
    </div>

    <!-- Contenu principal -->
    <div class="modal-content" *ngIf="!isLoading && !errorMessage && user">

      <!-- Informations utilisateur -->
      <div class="user-info-section">
        <div class="user-avatar">
          <img *ngIf="user.profilePicture; else avatarPlaceholder" [src]="user.profilePicture" [alt]="user.username">
          <ng-template #avatarPlaceholder>
            <div class="avatar-initials">
              {{ user ? getUserInitials(user) : '' }}
            </div>
          </ng-template>
        </div>
        <div class="user-details">
          <h3 class="username">{{ user.username }}</h3>
          <p class="user-email">{{ user.email }}</p>
          <div class="current-role">
            <span class="role-label">Rôle actuel:</span>
            <span class="role-badge" [class]="'role-' + user.role">
              {{ getRoleLabel(user.role || '') }}
            </span>
          </div>
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="quick-actions">
        <div class="action-group">
          <label class="action-label">Actions rapides:</label>
          <div class="action-buttons">
            <button class="btn btn-outline btn-sm" (click)="onAction('grant_all')"
              [disabled]="isAllGranted() || !canModifyPermissions()">
              <i class="icon-check-square"></i>
              Tout accorder
            </button>
            <button class="btn btn-outline btn-sm" (click)="onAction('revoke_all')"
              [disabled]="isAllRevoked() || !canModifyPermissions()">
              <i class="icon-square"></i>
              Tout révoquer
            </button>
            <button class="btn btn-outline btn-sm" (click)="onAction('reset')" [disabled]="!hasChanges()">
              <i class="icon-refresh-cw"></i>
              Réinitialiser
            </button>
          </div>
        </div>
      </div>

      <!-- Changement de rôle -->
      <div class="role-section" *ngIf="canChangeRole()">
        <div class="section-header">
          <h3 class="section-title">
            <i class="icon-user-check"></i>
            Changement de rôle
          </h3>
          <p class="section-description">
            Modifier le rôle change automatiquement les permissions de base
          </p>
        </div>
        <div class="role-selector">
          <label for="role-select" class="sr-only">Sélectionner un rôle</label>
          <select id="role-select" [value]="selectedRole || user.role" (change)="onRoleChange($event)"
            class="role-select">
            <option value="user">Utilisateur</option>
            <option value="contributor">Contributeur</option>
            <option value="admin" [disabled]="!canAssignRole(UserRole.ADMIN)">Administrateur</option>
            <option value="superadmin" [disabled]="!canAssignRole(UserRole.SUPERADMIN)">Super Admin</option>
          </select>
        </div>
      </div>

      <!-- Groupes de permissions -->
      <div class="permissions-section">
        <div class="section-header">
          <h3 class="section-title">
            <i class="icon-shield"></i>
            Permissions détaillées
          </h3>
          <p class="section-description">
            Permissions spécifiques pour des fonctionnalités avancées
          </p>
        </div>

        <div class="permissions-groups">
          <div *ngFor="let group of permissionGroups; trackBy: trackByGroupId" class="permission-group"
            [class.group-expanded]="isGroupExpanded(group.id)">

            <!-- Header du groupe -->
            <div class="group-header" (click)="toggleGroup(group.id)" role="button" tabindex="0"
              (keydown.enter)="toggleGroup(group.id)" (keydown.space)="toggleGroup(group.id, $event)">
              <div class="group-info">
                <h4 class="group-name">{{ group.name }}</h4>
                <p class="group-description">{{ group.description }}</p>
                <div class="group-stats">
                  {{ getGroupGrantedCount(group) }} / {{ group.permissions.length }} accordées
                </div>
              </div>
              <div class="group-toggle">
                <i [class]="getGroupToggleIcon(group.id)"></i>
              </div>
            </div>

            <!-- Permissions du groupe -->
            <div class="group-permissions" [class.expanded]="isGroupExpanded(group.id)">
              <div *ngFor="let permission of group.permissions; trackBy: trackByPermissionId" class="permission-item"
                [class]="'permission-' + permission.category">

                <div class="permission-checkbox">
                  <input type="checkbox" [id]="'perm-' + permission.id" [checked]="permission.granted"
                    [disabled]="permission.disabled || !canModifyPermissions()"
                    (change)="onPermissionChange(permission, $event)">
                  <label [for]="'perm-' + permission.id" class="sr-only">
                    {{ permission.name }}
                  </label>
                </div>

                <div class="permission-info">
                  <div class="permission-header">
                    <span class="permission-name">{{ permission.name }}</span>
                    <div class="permission-badges">
                      <span class="category-badge" [class]="'category-' + permission.category"
                        [title]="getCategoryDescription(permission.category)">
                        {{ getCategoryLabel(permission.category) }}
                      </span>
                      <span *ngIf="permission.disabled" class="disabled-badge"
                        title="Cette permission est gérée par le rôle">
                        Rôle
                      </span>
                    </div>
                  </div>
                  <p class="permission-description">{{ permission.description }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Résumé des changements -->
      <div class="changes-summary" *ngIf="hasChanges()">
        <div class="summary-header">
          <h3 class="summary-title">
            <i class="icon-edit-3"></i>
            Modifications à appliquer
          </h3>
        </div>
        <div class="changes-list">
          <div *ngFor="let change of getPermissionChanges(); trackBy: trackByChangeId" class="change-item"
            [class]="change.granted ? 'change-granted' : 'change-revoked'">
            <i [class]="change.granted ? 'icon-plus' : 'icon-minus'"></i>
            <span class="change-text">
              {{ getPermissionName(change.permission) }}
              <strong>{{ change.granted ? 'accordée' : 'révoquée' }}</strong>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer avec actions -->
    <div class="modal-footer" *ngIf="!isLoading && !errorMessage">
      <div class="footer-info">
        <span class="changes-count" *ngIf="hasChanges()">
          {{ getPermissionChanges().length }} modification(s) en attente
        </span>
      </div>
      <div class="footer-actions">
        <button class="btn btn-outline" (click)="onAction('cancel')" type="button">
          Annuler
        </button>
        <button class="btn btn-primary" (click)="onAction('save')" [disabled]="!hasChanges() || isLoading"
          type="button">
          <i class="icon-save"></i>
          Enregistrer les modifications
        </button>
      </div>
    </div>
  </div>
</div>
